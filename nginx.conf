user  nginx;
worker_processes  auto;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    client_max_body_size 100M;

    upstream fastcgi_backend {
        server magento_php:9000;
    }

    server {
        listen 80;
        server_name local.magento;
        set $MAGE_ROOT /var/www/html;
        set $MAGE_MODE developer;

        root $MAGE_ROOT/pub;

        index index.php index.html;

        location / {
            try_files $uri $uri/ /index.php$is_args$args;
        }

        location /pub/ {
            location ~ ^/pub/media/.*\.php$ {
                deny all;
            }
            location ~ ^/pub/static/.*\.php$ {
                deny all;
            }
        }

        location /static/ {
            expires max;
            location ~ ^/static/version {
                rewrite ^/static/(version\d*/)?(.*)$ /static/$2 last;
            }
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|ttf|woff|woff2)$ {
                add_header Cache-Control "public";
                expires +1y;
                access_log off;
            }
            try_files $uri $uri/ /index.php$is_args$args;
        }

        location /media/ {
            try_files $uri $uri/ /index.php$is_args$args;
        }

        location ~ (index|get|static|report|404|503)\.php$ {
            try_files $uri =404;
            fastcgi_pass fastcgi_backend;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            include fastcgi_params;
            fastcgi_buffers 16 16k;
            fastcgi_buffer_size 32k;
        }

        location ~* \.(php|phtml)$ {
            deny all;
        }

        error_page 404 /errors/404.php;
        location ~ /errors/ {
            internal;
        }

        log_not_found off;
        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;
    }
}
